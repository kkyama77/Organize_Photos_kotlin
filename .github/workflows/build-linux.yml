name: Build Linux Binary

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:   # 手動実行を可能にする

jobs: 
  build-linux:
    runs-on:  ubuntu-latest
    
    steps:
    - name: リポジトリのチェックアウト
      uses: actions/checkout@v4
    
    - name: JDK 17 のセットアップ
      uses: actions/setup-java@v4
      with: 
        distribution: 'temurin'
        java-version: '17'
    
    - name: Gradle のセットアップ
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.7'
    
    - name: 利用可能なGradleタスクを確認
      run: gradle tasks --all | grep -i package
    
    - name: Linuxバイナリのビルド (.deb)
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 60
        max_attempts: 3
        command: gradle :composeApp:packageDeb --no-daemon --stacktrace
    
    - name: ビルド成果物の確認
      run: |
        echo "=== composeApp/build ディレクトリの構造 ==="
        find composeApp/build -type f -name "*.deb" 2>/dev/null || echo ".debファイルが見つかりません"
        echo ""
        echo "=== build ディレクトリ全体の構造 ==="
        find composeApp/build/compose 2>/dev/null || echo "composeApp/build/composeが存在しません"
    
    - name: .debパッケージのアップロード
      uses: actions/upload-artifact@v4
      with:
        name: organize-photos-linux-deb
        path: |
          composeApp/build/compose/binaries/main/deb/*.deb
          composeApp/build/compose/binaries/main-release/deb/*.deb
          composeApp/build/distributions/*.deb
        if-no-files-found: error
    
    - name:  AppImageのビルド (オプション)
      run: gradle :composeApp:packageUberJarForCurrentOS --no-daemon --stacktrace
      continue-on-error: false
    
    - name: UberJarのアップロード
      uses:  actions/upload-artifact@v4
      with:
        name:  organize-photos-linux-jar
        path: composeApp/build/compose/jars/*.jar
      continue-on-error: true
