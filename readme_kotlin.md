# Kotlin Multiplatform 版 要件定義

## 🖥️ 現在の対応状況
**✅ Desktop版（Windows/macOS/Linux）完全対応**
- 以下のすべての機能がデスクトップ環境で動作します

**⚠️ Android/iOS 未対応**
- 共通UI・ロジックは実装済みですが、モバイル固有機能（ストレージアクセス、サムネイル生成等）は未実装です
- モバイル対応は今後の開発ブランチで実装予定

---

## 対応プラットフォーム
- ✅ **Windows / macOS / Linux** - 完全対応
- ⚠️ iOS / Android - UI/ロジックのみ（プラットフォーム固有機能未実装）

## 機能要件
- フォルダ選択: 写真格納フォルダを指定
- スキャン: 配下の画像を再帰列挙（JPEG/PNG/HEIC/TIFF 等）
- メタデータ抽出: 撮影日時・解像度・サイズ・拡張子（EXIF優先）
- サムネ生成: 非同期でサムネイル生成＋キャッシュ（ディスク＋メモリ）
- 一覧表示: 仮想リスト（LazyColumn/LazyVerticalGrid）で高速表示
- 検索/フィルタ: テキスト検索（日本語IME対応）、日付レンジ、拡張子フィルタ
- 選択/操作: 複数選択、詳細ビュー（将来: コピー/移動/削除に拡張）
- エラー通知: 権限/パス不正/サムネ生成失敗をUI提示
- 設定: サムネキャッシュ上限、対象拡張子、既定フォルダ記憶

## 非機能要件
- パフォーマンス: 数千枚でも快適スクロール/検索
- メモリ: サムネは上限付きキャッシュ（LRU）
- 応答性: バックグラウンド生成→逐次反映
- 国際化: 日本語UI・IME前提（英語追加は将来）
- 配布: 各OSネイティブパッケージ、モバイルはストア配布前提

## 技術スタック
- UI: Compose Multiplatform（Desktop + Android + iOS）
- ロジック: Kotlin Multiplatform 共有コード（スキャン/メタデータ/検索）
- 画像/EXIF: KMP対応ライブラリ（例: metadata-extractor JVM、iOS/Androidは別実装）
- キャッシュ: 共通ロジック＋プラットフォーム適合ストレージ（デスクトップ=ファイル、モバイル=ファイル+DB）
- ビルド: Gradle (KMP), JDK 17, Android Studio or IntelliJ, iOSはXcode必須
- テスト: 共有ロジックはKMPテスト、固有部分は別途UI/インストルメンテーション

## アーキテクチャ方針
- 共有層: スキャン/メタデータ/検索/キャッシュ制御をKMP共通に集約
- UI層: Composeコンポーネントを共通化し、エントリだけプラットフォーム別
- 非同期: コルーチンでバックグラウンド処理、メインへスナップショット反映
- 拡張性: 将来の重複検出・AIタグ付け等をモジュール追加で対応

## 初期マイルストーン
1. KMP + Compose Desktop テンプレ生成、デスクトップでダミー画像リスト表示
2. 実フォルダスキャンとメタデータ抽出を共通ロジックに実装（JPEG/PNG/HEIC/TIFF対応）
3. サムネ生成＋キャッシュ＋仮想リストで数千枚性能確認
4. 検索/フィルタ（テキスト・日付・拡張子）を追加
5. モバイル（Android→iOS）ビルドを有効化し、同UIを流用

## 現在の実装状況（Desktop版完成）
- ✅ フォルダ選択 → 再帰スキャン（拡張子フィルタ対応）
- ✅ EXIF読み取り（metadata-extractor）
- ✅ サムネイル生成＋キャッシュ（LRUメモリキャッシュ＋ディスクキャッシュ）
- ✅ 仮想リスト（LazyVerticalGrid）で数千枚高速表示
- ✅ テキスト検索（日本語／英語表記ゆれ対応、カタカナ↔ひらがな統一、全角↔半角統一、同義語展開）
- ✅ 日付レンジフィルタ＋拡張子フィルタ
- ✅ 撮影情報フィルター（EXIF詳細検索：カメラ機種、レンズ、ISO、絞り値等）
- ✅ 複合検索（簡易検索 + 撮影情報フィルター AND結合）
- ✅ ユーザーメタデータ（タイトル、タグ、コメント）をXMPサイドカー（`.xmp/`フォルダ）に保存
- ✅ 右クリックコンテキストメニュー（プロパティ編集、デフォルトアプリで開く）
- ✅ スクロール位置保持（メタデータ編集後も表示位置維持）
- ✅ 検索モード切替（OR/AND）
- ✅ UI最適化（1400x900ウィンドウ、テキストサイズ調整）

**モバイル（Android/iOS）対応は今後のブランチで実装予定**

## 使い方（ローカルビルド）
前提: JDK 17

1. デスクトップ実行: 
   ```bash
   ./gradlew :composeApp:run
   # または直接Gradle実行
   ./gradle-8.7/bin/gradle :composeApp:run
   ```
3. 共通テスト: `./gradlew :composeApp:allTests`
4. Android ビルド（エミュレータ/端末に転送）: `./gradlew :composeApp:assembleDebug`
5. iOS: Xcode で `iosApp` ターゲットを設定し、`MainViewController()` をエントリとして利用（UIKit/Compose Multiplatform）

## 次にやること
- 実フォルダスキャン（デスクトップ: java.nio + metadata-extractor を呼び出すロジック実装）
- サムネイル生成（ImageIO/Skia 経由）と LRU キャッシュ統合
- Android/iOS のストレージ権限処理とフォルダピッカー導入
- 検索UIを日付レンジ/拡張子複合フィルタに拡張
